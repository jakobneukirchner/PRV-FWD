<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proeve.net - Weiterleitung</title>
    <style>
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --accent-gold: #d4af37;
            --accent-hover: #f0c952;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            line-height: 1.6;
        }

        .container {
            max-width: 700px;
            width: 100%;
            background: rgba(26, 26, 26, 0.8);
            border-radius: 12px;
            padding: 3rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 1rem;
            color: var(--accent-gold);
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-style: italic;
        }

        .loading-container {
            text-align: center;
            padding: 2rem 0;
        }

        .spinner {
            border: 3px solid rgba(212, 175, 55, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--accent-gold);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .target-url {
            color: var(--accent-gold);
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border-left: 3px solid var(--accent-gold);
        }

        .warning-box {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid var(--accent-gold);
            border-radius: 8px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .warning-box h2 {
            color: var(--accent-gold);
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .warning-box p {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            line-height: 1.8;
        }

        .warning-text {
            background: rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
            border-radius: 6px;
            margin: 1rem 0;
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .warning-text h3 {
            color: var(--accent-gold);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .warning-text h3:first-child {
            margin-top: 0;
        }

        .warning-text p {
            margin-bottom: 0.8rem;
        }

        .warning-text ul, .warning-text ol {
            margin-left: 1.5rem;
            margin-bottom: 0.8rem;
        }

        .warning-text strong {
            color: var(--accent-gold);
        }

        .warning-text em {
            font-style: italic;
            color: var(--text-primary);
        }

        .warning-text .var-countdown {
            color: var(--accent-gold);
            font-weight: 600;
            font-size: 1.1em;
        }

        .warning-text .var-url {
            color: var(--accent-gold);
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .warning-text .var-delay {
            color: var(--accent-gold);
            font-weight: 600;
        }

        .error {
            background: rgba(255, 50, 50, 0.1);
            border: 1px solid rgba(255, 50, 50, 0.3);
            color: #ff6b6b;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .error h2 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            color: #ff8787;
        }

        .btn {
            display: inline-block;
            margin-top: 1.5rem;
            padding: 0.8rem 2rem;
            background: var(--accent-gold);
            color: var(--bg-primary);
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        .btn:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--accent-gold);
            color: var(--accent-gold);
            margin-left: 1rem;
        }

        .btn-secondary:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .countdown {
            font-size: 2rem;
            color: var(--accent-gold);
            font-weight: 600;
            margin: 1rem 0;
        }

        .info {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(212, 175, 55, 0.2);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .info strong {
            color: var(--accent-gold);
        }

        .button-container {
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 2rem 1.5rem;
            }
            
            h1 {
                font-size: 2rem;
            }

            .button-container {
                flex-direction: column;
            }

            .btn-secondary {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Proeve.net</h1>
        <p class="subtitle">Weiterleitungsservice</p>
        
        <div class="loading-container" id="loadingContainer">
            <div class="spinner"></div>
            <p class="message">Weiterleitung wird vorbereitet...</p>
            <div class="target-url" id="targetUrl"></div>
        </div>

        <div class="info">
            <p><strong>Hinweis:</strong></p>
            <p>Für den Inhalt verlinkter externer Internetseiten wird keine Gewähr übernommen, da die Verantwortung hierfür ausschließlich beim jeweiligen Anbieter liegt.</p>
            <p>Version: <code>V2.2.0</code></p>
        </div>
    </div>

    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const directUrl = urlParams.get('fwd');
        const directoryId = urlParams.get('fwd-v');
        const delayParam = urlParams.get('delay');
        const modeParam = urlParams.get('mode');

        const loadingContainer = document.getElementById('loadingContainer');
        const targetUrlElement = document.getElementById('targetUrl');

        let redirectMode = 'auto';
        let redirectDelay = 2;
        let countdownInterval = null;

        if (modeParam) {
            const validModes = ['auto', 'instant', 'button', 'button-delay', 'wait'];
            if (validModes.includes(modeParam)) {
                redirectMode = modeParam;
            }
        }

        if (delayParam) {
            const parsedDelay = parseInt(delayParam);
            if (!isNaN(parsedDelay) && parsedDelay >= 0 && parsedDelay <= 300) {
                redirectDelay = parsedDelay;
            }
        }

        async function loadDirectory() {
            try {
                const response = await fetch('directory.txt');
                if (!response.ok) {
                    throw new Error('Verzeichnis konnte nicht geladen werden');
                }
                const text = await response.text();
                const lines = text.split('\n').filter(line => line.trim() && !line.trim().startsWith('#'));
                const directory = {};
                
                lines.forEach(line => {
                    const parts = line.split(';');
                    if (parts.length >= 2) {
                        const id = parts[0].trim();
                        const url = parts[1].trim();
                        const warning = parts[2] ? parts[2].trim() : null;
                        const warningMode = parts[3] ? parts[3].trim() : 'auto';
                        const warningDelay = parts[4] ? parseInt(parts[4].trim()) : 5;
                        
                        directory[id] = {
                            url: url,
                            warning: warning,
                            warningMode: warningMode,
                            warningDelay: warningDelay
                        };
                    }
                });
                
                return directory;
            } catch (error) {
                console.error('Error loading directory:', error);
                return null;
            }
        }

        function validateUrl(url) {
            try {
                const parsed = new URL(url);
                return parsed.protocol === 'http:' || parsed.protocol === 'https:';
            } catch {
                return false;
            }
        }

        function showError(title, message, url = null) {
            loadingContainer.innerHTML = `
                <div class="error">
                    <h2>${title}</h2>
                    <p>${message}</p>
                    ${url ? `<a href="${url}" class="btn">Zurück zu Proeve.net</a>` : ''}
                </div>
            `;
        }

        function executeRedirect(targetUrl) {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            window.location.href = targetUrl;
        }

        function replaceVariables(text, url, delay, currentCountdown) {
            return text
                .replace(/\{countdown\}/g, `<span class="var-countdown">${currentCountdown}</span>`)
                .replace(/\{url\}/g, `<span class="var-url">${escapeHtml(url)}</span>`)
                .replace(/\{delay\}/g, `<span class="var-delay">${delay}</span>`);
        }

        function updateVariablesInText(url, delay, currentCountdown) {
            // Update all countdown variables
            const countdownElements = document.querySelectorAll('.var-countdown');
            countdownElements.forEach(el => {
                el.textContent = currentCountdown;
            });
        }

        function startCountdown(seconds, callback, url, delay) {
            let remaining = seconds;
            const countdownElement = document.getElementById('countdown');
            
            // Initial update
            if (countdownElement) {
                countdownElement.textContent = remaining;
            }
            updateVariablesInText(url, delay, remaining);
            
            countdownInterval = setInterval(() => {
                remaining--;
                if (countdownElement) {
                    countdownElement.textContent = remaining;
                }
                updateVariablesInText(url, delay, remaining);
                
                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    callback();
                }
            }, 1000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showRedirectInterface(targetUrl, mode, delay) {
            targetUrlElement.textContent = targetUrl;

            if (mode === 'instant') {
                loadingContainer.innerHTML = `
                    <p class="message">Weiterleitung...</p>
                    <div class="target-url">${escapeHtml(targetUrl)}</div>
                `;
                executeRedirect(targetUrl);
            }
            else if (mode === 'auto') {
                loadingContainer.innerHTML = `
                    <div class="spinner"></div>
                    <p class="message">Weiterleitung in <span class="countdown" id="countdown">${delay}</span> Sekunden...</p>
                    <div class="target-url">${escapeHtml(targetUrl)}</div>
                    <div class="button-container">
                        <button class="btn" onclick="executeRedirect('${targetUrl.replace(/'/g, "\\'")}')">Jetzt weiterleiten</button>
                        <a href="https://proeve.net" class="btn btn-secondary">Zurück zu Proeve.net</a>
                    </div>
                `;
                startCountdown(delay, () => executeRedirect(targetUrl), targetUrl, delay);
            }
            else if (mode === 'wait') {
                loadingContainer.innerHTML = `
                    <div class="spinner"></div>
                    <p class="message">Bitte warten Sie <span class="countdown" id="countdown">${delay}</span> Sekunden...</p>
                    <div class="target-url">${escapeHtml(targetUrl)}</div>
                    <div class="button-container">
                        <a href="https://proeve.net" class="btn btn-secondary">Zurück zu Proeve.net</a>
                    </div>
                `;
                startCountdown(delay, () => executeRedirect(targetUrl), targetUrl, delay);
            }
            else if (mode === 'button') {
                loadingContainer.innerHTML = `
                    <p class="message">Klicken Sie auf den Button, um fortzufahren</p>
                    <div class="target-url">${escapeHtml(targetUrl)}</div>
                    <div class="button-container">
                        <button class="btn" onclick="executeRedirect('${targetUrl.replace(/'/g, "\\'")}')">Weiter zur Zielseite</button>
                        <a href="https://proeve.net" class="btn btn-secondary">Zurück zu Proeve.net</a>
                    </div>
                `;
            }
            else if (mode === 'button-delay') {
                loadingContainer.innerHTML = `
                    <div class="spinner"></div>
                    <p class="message">Bitte warten Sie <span class="countdown" id="countdown">${delay}</span> Sekunden...</p>
                    <div class="target-url">${escapeHtml(targetUrl)}</div>
                    <div class="button-container">
                        <button class="btn" id="delayedButton" disabled>Bitte warten...</button>
                        <a href="https://proeve.net" class="btn btn-secondary">Zurück zu Proeve.net</a>
                    </div>
                `;
                
                startCountdown(delay, () => {
                    const button = document.getElementById('delayedButton');
                    if (button) {
                        button.disabled = false;
                        button.textContent = 'Weiter zur Zielseite';
                        button.onclick = () => executeRedirect(targetUrl);
                        const spinner = document.querySelector('.spinner');
                        if (spinner) spinner.remove();
                        const message = document.querySelector('.message');
                        if (message) message.textContent = 'Sie können jetzt fortfahren';
                    }
                }, targetUrl, delay);
            }
        }

        function showWarningInterface(entry, directoryId) {
            const targetUrl = entry.url;
            const warningText = entry.warning;
            const warningMode = entry.warningMode || 'auto';
            const warningDelay = entry.warningDelay || 5;

            // Replace variables in warning text
            const processedWarning = replaceVariables(warningText, targetUrl, warningDelay, warningDelay);

            if (warningMode === 'auto') {
                loadingContainer.innerHTML = `
                    <div class="warning-box">
                        <h2>⚠️ Hinweis</h2>
                        <div class="warning-text">${processedWarning}</div>
                        <p>Weiterleitung in <span class="countdown" id="countdown">${warningDelay}</span> Sekunden...</p>
                        <div class="target-url">${escapeHtml(targetUrl)}</div>
                        <div class="button-container">
                            <button class="btn" onclick="executeRedirect('${targetUrl.replace(/'/g, "\\'")}')">Jetzt weiterleiten</button>
                            <a href="https://proeve.net" class="btn btn-secondary">Zurück zu Proeve.net</a>
                        </div>
                    </div>
                `;
                startCountdown(warningDelay, () => executeRedirect(targetUrl), targetUrl, warningDelay);
            }
            else if (warningMode === 'wait') {
                loadingContainer.innerHTML = `
                    <div class="warning-box">
                        <h2>⚠️ Hinweis</h2>
                        <div class="warning-text">${processedWarning}</div>
                        <p>Weiterleitung in <span class="countdown" id="countdown">${warningDelay}</span> Sekunden...</p>
                        <div class="target-url">${escapeHtml(targetUrl)}</div>
                        <div class="button-container">
                            <a href="https://proeve.net" class="btn btn-secondary">Zurück zu Proeve.net</a>
                        </div>
                    </div>
                `;
                startCountdown(warningDelay, () => executeRedirect(targetUrl), targetUrl, warningDelay);
            }
            else if (warningMode === 'button') {
                loadingContainer.innerHTML = `
                    <div class="warning-box">
                        <h2>⚠️ Hinweis</h2>
                        <div class="warning-text">${processedWarning}</div>
                        <div class="target-url">${escapeHtml(targetUrl)}</div>
                        <div class="button-container">
                            <button class="btn" onclick="executeRedirect('${targetUrl.replace(/'/g, "\\'")}')">Weiter zur Zielseite</button>
                            <a href="https://proeve.net" class="btn btn-secondary">Zurück zu Proeve.net</a>
                        </div>
                    </div>
                `;
            }
            else if (warningMode === 'button-delay') {
                loadingContainer.innerHTML = `
                    <div class="warning-box">
                        <h2>⚠️ Hinweis</h2>
                        <div class="warning-text">${processedWarning}</div>
                        <p>Bitte warten Sie <span class="countdown" id="countdown">${warningDelay}</span> Sekunden...</p>
                        <div class="target-url">${escapeHtml(targetUrl)}</div>
                        <div class="button-container">
                            <button class="btn" id="delayedButton" disabled>Bitte warten...</button>
                            <a href="https://proeve.net" class="btn btn-secondary">Zurück zu Proeve.net</a>
                        </div>
                    </div>
                `;
                
                startCountdown(warningDelay, () => {
                    const button = document.getElementById('delayedButton');
                    if (button) {
                        button.disabled = false;
                        button.textContent = 'Weiter zur Zielseite';
                        button.onclick = () => executeRedirect(targetUrl);
                        const message = document.querySelector('.warning-box p');
                        if (message && message.querySelector('#countdown')) {
                            message.textContent = 'Sie können jetzt fortfahren';
                        }
                    }
                }, targetUrl, warningDelay);
            }
        }

        async function redirect() {
            let targetUrl = null;
            let showWarning = false;
            let directoryEntry = null;

            if (directUrl) {
                if (validateUrl(directUrl)) {
                    targetUrl = directUrl;
                } else {
                    showError(
                        'Ungültige URL',
                        'Die angegebene URL ist nicht gültig. Bitte überprüfen Sie das Format.',
                        'https://proeve.net'
                    );
                    return;
                }
            }
            else if (directoryId) {
                const directory = await loadDirectory();
                
                if (!directory) {
                    showError(
                        'Verzeichnis-Fehler',
                        'Das URL-Verzeichnis konnte nicht geladen werden.',
                        'https://proeve.net'
                    );
                    return;
                }

                if (directory[directoryId]) {
                    directoryEntry = directory[directoryId];
                    targetUrl = directoryEntry.url;
                    
                    if (directoryEntry.warning) {
                        showWarning = true;
                    }
                } else {
                    showError(
                        'ID nicht gefunden',
                        `Die Verzeichnis-ID "${directoryId}" existiert nicht.`,
                        'https://proeve.net'
                    );
                    return;
                }
            }
            else {
                targetUrl = 'https://proeve.net';
            }

            if (showWarning && directoryEntry) {
                showWarningInterface(directoryEntry, directoryId);
            } else if (targetUrl) {
                showRedirectInterface(targetUrl, redirectMode, redirectDelay);
            }
        }

        redirect();
    </script>
</body>
</html>